package dev.sm1le.avaranusSMP.modules.server.prohibition.exploit.service;

import dev.sm1le.avaranusSMP.modules.webhook.WebhookService;
import dev.sm1le.avaranusSMP.modules.webhook.WebhookType;
import org.bukkit.Bukkit;
import org.bukkit.GameMode;
import org.bukkit.Material;
import org.bukkit.block.Block;
import org.bukkit.entity.Player;
import org.bukkit.inventory.ItemStack;
import org.bukkit.plugin.java.JavaPlugin;

public class ExploitService {

    private final JavaPlugin plugin;
    private final WebhookService webhook;

    public ExploitService(JavaPlugin plugin) {
        this.plugin = plugin;
        this.webhook = new WebhookService(plugin);
    }

    /* ==== Универсальная реакция ==== */
    public void cancel(Player player, String reason) {
        player.sendMessage("§cДействие заблокировано: " + reason);
        plugin.getLogger().warning("[Exploit] " + player.getName() + " → " + reason);
        webhook.send(
                WebhookType.EXPLOIT_ALERT,
                "Игрок **" + player.getName() + "**\n"
                        + "Причина: " + reason + "\n"
                        + "Мир: " + player.getWorld().getName()
        );
        // Здесь можно добавить webhook уведомления
    }

    /* ==== Item Exploit ==== */
    public boolean isIllegalItem(ItemStack item) {
        if (item == null) return false;

        if (item.getAmount() > item.getMaxStackSize()) return true;

        if (item.hasItemMeta()) {
            if (item.getItemMeta().hasLore()) {
                for (String lore : item.getItemMeta().getLore()) {
                    if (lore.contains("\u0000")) return true; // баг-тэг
                }
            }
            if (item.getItemMeta().hasCustomModelData() && item.getItemMeta().getCustomModelData() > 10000)
                return true; // protection from huge custom model data
        }

        return false;
    }

    /* Movement Exploit */
    public boolean illegalMovement(Player p) {
        if (p.getGameMode() == GameMode.CREATIVE) return false;
        if (p.isFlying() && !p.getAllowFlight()) return true;
        if (p.getVelocity().length() > 10) return true;
        return false;
    }


    public boolean tooManyBlocksNearby(Block block, int radius, int max) {
        int count = 0;
        for (int x=-radius;x<=radius;x++)
            for (int y=-radius;y<=radius;y++)
                for (int z=-radius;z<=radius;z++) {
                    Block b = block.getRelative(x,y,z);
                    if (b.getType() == Material.HOPPER || b.getType() == Material.DROPPER || b.getType() == Material.DISPENSER) count++;
                }
        return count > max;
    }

    public boolean explosiveBlock(Block block) {
        return switch (block.getType()) {
            case TNT, LAVA, WATER -> true;
            default -> false;
        };
    }
}